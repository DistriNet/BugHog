access_log /logs/nginx-access-poc.log default_format;

location = /favicon.ico {
    alias /www/data/res/bughog.ico;
}

# Home
location = / {
    proxy_pass http://core:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}

# Shared static resources
location ^~ /res/ {
    root /www/data;
    mirror /notify_collector;
}

# Reporting endpoint
location ~ ^/report/.*$ {
    proxy_pass http://core:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Dynamic experiment resources
location ~ (.+).py$ {
    proxy_pass http://core:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

location ~ ^/([^/]+)/([^/]+)(/.*)?$ {
    access_by_lua_block {
        local project = ngx.var[1]
        local poc = ngx.var[2]
        local resource_path = ngx.var[3] or ""

        local file_path
        if resource_path == "" or resource_path == nil or resource_path == "/" then
            file_path = "/www/data/poc/" .. project .. "/" .. poc .. "/index.html"
        else
            file_path = "/www/data/poc/" .. project .. "/" .. poc .. resource_path
        end

        local file = io.open(file_path, "r")
        if not file then
            ngx.log(ngx.ERR, "PoC not found (path: " .. file_path .. ").")
            return  -- let try_files resolve to 404 or fallback.
        end

        local headers = {}
        local status_code = nil
        local ext = (file_path:match("%.([^.]+)$") or "html"):lower()

        local function apply(k, v)
            if not k or not v then return end
            if k:lower() == "status" then
                local n = tonumber(v)
                if n then status_code = n end
            else
                headers[k] = v
            end
        end

        local function parse_header_line(s)
            local name, value = s:match("([%w%-]+)%s*:%s*(.+)%s*")
            if name and value then
                ngx.log(ngx.INFO, "Parsed header: '" .. s .. "' --> name: " .. name .. ", value: " .. value)
                apply(name, value)
            else
                ngx.log(ngx.WARN, "Could not parse header for '" .. s .. "'")
            end
        end

        for line in file:lines() do

            if line:match("^%s*<!DOCTYPE") then
                -- Ignore line with DOCTYPE declaration

            elseif ext == "html" then
                -- HTML single-line: <!-- Header-Name: value -->
                local match = line:match("^%s*<!%-%-%s*(.-)%s*%-%->")
                if match then
                    if match:find("^bughog_") then
                        -- Nginx ignores bughog parameters.
                    else
                        parse_header_line(match)
                    end
                else
                    break
                end

            elseif ext == "js" then
                -- JS single-line: // Header-Name: value
                local match = line:match("^%s*//%s*(.-)%s*$")
                if match then
                    if match:find("^bughog_") then
                        -- Nginx ignores bughog parameters.
                    else
                        parse_header_line(match)
                    end
                else
                    break
                end

            elseif ext == "css" then
                -- CSS supports only block comments: /* Header-Name: value */
                local match = line:match("^%s*/%*%s*(.-)%s*%*/%s*$")
                if match then
                    if match:find("^bughog_") then
                        -- Nginx ignores bughog parameters.
                    else
                        parse_header_line(match)
                    end
                else
                    break
                end

            else
                -- Only consider HTML, JS and CSS.
                break
            end
        end
        file:close()

        -- Set status code if defined
        if status_code then
            ngx.log(ngx.INFO, "Setting status code: " .. status_code)
            ngx.ctx.status_code = status_code
        end

        -- Set extracted headers
        ngx.ctx.extra_headers = headers
    }

    # Status code needs to be set in this block, to prevent overwriting by nginx.
    header_filter_by_lua_block {
        if ngx.ctx.status_code then
            ngx.status = ngx.ctx.status_code
        end
        local h = ngx.ctx.extra_headers
        if h then
            for k, v in pairs(h) do
                ngx.header[k] = v
            end
        end
    }

    # Nginx still serves the file, preserving automatic Content-Type.
    root /www/data/poc;
    try_files /$1/$2$3 /$1/$2/index.html =404;

    mirror /notify_collector;
}

location = /notify_collector {
    include /etc/nginx/config/notify_collector.conf;
}
